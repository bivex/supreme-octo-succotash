# üßµ –¢–µ—Å—Ç—ã –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏

## –û–±–∑–æ—Ä

–ù–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## –ó–∞–ø—É—Å–∫ –¢–µ—Å—Ç–æ–≤

### –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
```bash
python scripts/testing/test_threading_sync.py
```

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```bash
python test_sync_quick.py
```

## –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

### 1. –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
- ‚úÖ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø 10+ –ø–æ—Ç–æ–∫–æ–≤ –∫ `container.get_postgres_upholder()`
- ‚úÖ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ `container.get_postgres_cache_monitor()`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è BackgroundServiceManager
- ‚úÖ Thread-safe –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (`start_postgres_upholder`, `start_cache_monitor`)
- ‚úÖ Thread-safe –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (`stop_all_services`)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions –ø—Ä–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å–µ—Ä–≤–∏—Å–æ–≤

### 3. –†–∞–±–æ—Ç–∞ —Å Connection Pool
- ‚úÖ Thread-safe —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ/–≤–æ–∑–≤—Ä–∞—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏–∑ –ø—É–ª–∞
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ `DatabaseConnectionTester`

### 4. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ Race Conditions
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø–æ—Ç–æ–∫–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ
- ‚úÖ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

### 5. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
- ‚úÖ 10 –ø–æ—Ç–æ–∫–æ–≤ √ó 50 –∏—Ç–µ—Ä–∞—Ü–∏–π –∫–∞–∂–¥—ã–π
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (< 60 —Å–µ–∫ –≤—Å–µ–≥–æ)
- ‚úÖ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞ (< 5 —Å–µ–∫)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–µ—Å—Ç–æ–≤

```
tests/integration/test_threading_sync.py
‚îú‚îÄ‚îÄ TestThreadingSynchronization
‚îÇ   ‚îú‚îÄ‚îÄ test_concurrent_container_access     # –î–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
‚îÇ   ‚îú‚îÄ‚îÄ test_service_manager_thread_safety   # –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ test_connection_pool_thread_safety   # Connection pool
‚îÇ   ‚îú‚îÄ‚îÄ test_race_condition_prevention       # Race conditions
‚îÇ   ‚îú‚îÄ‚îÄ test_service_manager_lock_behavior   # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (mock)
‚îÇ   ‚îî‚îÄ‚îÄ test_performance_under_load          # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå Race condition –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
- ‚ùå –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
- ‚ùå –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å—Ç–æ—â–µ–Ω–∏–µ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ `BackgroundServiceManager` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `threading.RLock()`
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ `DatabaseConnectionTester` –∏–º–µ–µ—Ç –¥–≤–æ–π–Ω—É—é –∑–∞—â–∏—Ç—É
- ‚úÖ Thread-safe –¥–æ—Å—Ç—É–ø –∫ connection pool

## –ú–µ—Ç—Ä–∏–∫–∏ –£—Å–ø–µ—Ö–∞

- **0 –æ—à–∏–±–æ–∫** –ø—Ä–∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ
- **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç** (6/6)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö
- **–ù–µ—Ç deadlock'–æ–≤** –∏–ª–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–π

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ CI/CD

```yaml
# –ü—Ä–∏–º–µ—Ä –¥–ª—è GitHub Actions
- name: Test Threading Synchronization
  run: python scripts/testing/test_threading_sync.py
```

## –ë—ã—Å—Ç—Ä–∞—è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ deadlock'–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ connection pool
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç: `python test_sync_quick.py`
